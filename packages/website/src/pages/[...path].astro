---
import { getEntry } from 'astro:content';

import DefaultLayout from '@/layouts/default.layout.astro';
import { getCollectionParams } from '@/utils/collection.utils.js';
import { getDefaultRoute, prepareNavigation } from '@/utils/navigation.utils.js';

import { Navigation } from '@/components/navigation.component.jsx';
import { Page } from '@/components/page.component.jsx';
import { preparePage } from '@/utils/page.utils.js';
import { getCollection } from 'astro:content';

const { slug, isAdmin } = getCollectionParams(Astro.params.path as string);
const home = await getDefaultRoute();

// no slug, no problem - redirect to the first page
if (slug === undefined) {
  return Astro.redirect(home, 301);
}

// resolve current page using the astro entry resolver
const page = await preparePage(
  slug,
  slug => getEntry('pages', slug),
  filter => getCollection('chronicle', filter),
);

// check if collection and page exists and, due to browsers
// looking up some convenient files, handle requests with a 404
// https://github.com/withastro/astro/issues/6565#issuecomment-1477236472
// https://docs.astro.build/en/guides/server-side-rendering/#response
if (page === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

// resolve navigation items using the astro entry resolver
const items = await prepareNavigation(slug => getEntry('pages', slug), Astro.params.path);
---

<DefaultLayout pageTitle={page.data?.title} observeScroll={!isAdmin}>
  <Navigation
    client:load
    client:slot="header"
    current={Astro.params.path as string}
    href={home}
    items={items}
    slot="header"
  />
  <Page {...page} />
</DefaultLayout>
