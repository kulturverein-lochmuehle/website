---
import type { GetStaticPaths, GetStaticPathsItem } from 'astro';
import { getEntry } from 'astro:content';

import DefaultLayout from '@/layouts/default.layout.astro';
import { getCollectionParams } from '@/utils/collection.utils.js';

import { Navigation } from '@/components/navigation.component';
import { Page } from '@/components/page.component';

async function getDefaultRoute(): Promise<string> {
  const { data } = await getEntry('navigation', 'main');
  const [{ page, useSections }] = data.pages;
  if (!useSections) return page;

  const sectioned = await getEntry('pages', page);
  if (sectioned === undefined) return page;

  const slug = sectioned.data.blocks[0]?.slug;
  if (slug === undefined) return page;

  return `/${page}/${slug}`;
}

const { slug, isAdmin } = getCollectionParams(Astro.params.path as string);
const home = await getDefaultRoute();

// no slug, no problem - redirect to the first page
if (slug === undefined) {
  return Astro.redirect(home, 301);
}

const page = await getEntry('pages', slug);
const navigation = await getEntry('navigation', 'main');

// check if collection and page exists and, due to browsers
// looking up some convenient files, handle requests with a 404
// https://github.com/withastro/astro/issues/6565#issuecomment-1477236472
// https://docs.astro.build/en/guides/server-side-rendering/#response
if (page === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}
---

<DefaultLayout pageTitle={page.data?.title} observeScroll={!isAdmin}>
  {
    navigation && (
      <Navigation
        {...navigation}
        client:only="react"
        slot="header"
        slug={Astro.params.path as string}
        href={home}
      />
    )
  }
  <Page {...page} client:load />
</DefaultLayout>
