---
import { getCollection, getEntry } from 'astro:content';
import { getCollectionParams } from '@utils/collection.utils.js';
import DefaultLayout from '@layouts/default.layout.astro';

import Navigation from '@components/navigation.component.astro';
import { Page } from '@components/page.component.tsx';

const { path } = Astro.params;
let { slug } = getCollectionParams(path);

// no slug, no problem - redirect to the first page
if (slug === undefined) {
  const collection = await getCollection('verein');
  // sort collection and grab the first entry
  const [firstEntry] = collection.toSorted(({ data: a }, { data: b }) => a.sorting - b.sorting);
  return Astro.redirect(firstEntry.slug);
}

const current = await getEntry('verein', slug);

// check if collection and page exists and, due to browsers
// looking up some convenient files, handle requests with a 404
// https://github.com/withastro/astro/issues/6565#issuecomment-1477236472
// https://docs.astro.build/en/guides/server-side-rendering/#response
if (current === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}
---

<DefaultLayout pageTitle={current.data?.title}>
  <Navigation name="main" slot="header" />
  <Page data={current.data} slug={slug} />
</DefaultLayout>
